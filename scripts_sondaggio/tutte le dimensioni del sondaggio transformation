select * from sondaggio.progetto_andromeda pa where pa.genere 

select fascia_eta from sondaggio.progetto_andromeda 


drop table if exists dim_genere;

create table dim_genere as 
select row_number() over () as ids_genere, * from (
	select distinct pa.genere 
	from sondaggio.progetto_andromeda pa
);

drop table if exists dim_fascia_eta;

create table dim_fascia_eta as 
 select row_number() over (order by fascia_eta) as ids_fascia_eta, * from (
   select distinct pa.fascia_eta 
from sondaggio.progetto_andromeda pa

) t; 

select * from dim_fascia_eta dfe

select * from dim_genere
-- nella "grandezza_azienda" conviene un order by
-- adesso procediamo con la creazione della dim_provincia_domicilio



/*
 * in una botta sola
create table dim_provincia_domicilio as 
 select row_number() over () as ids_provincia_domicilio, * from (
	select distinct trim( lower(provincia_domicilio)) as provincia_domicilio
	from sondaggio.progetto_andromeda pa 
	order by provincia_domicilio
	) t
*/


/*
 * i tre passaggi
 * 
create table tt_provincia_domicilio_lower_01 as 
	select lower( pa.provincia_domicilio)
	from sondaggio.progetto_andromeda pa

create table tt_provincia_domicilio_trimmed_02 as 
	select trim( provincia_domicilio)
	from tt_provincia_domicilio_lower_01

create table dim_provincia_domicilio as 
 select row_number() over () as ids_provincia_domicilio, * 
 	from tt_provincia_domicilio_trimmed_02
*/	
		
--il famoso in una botta sola, da tutte le provincie con gli errori
	drop table if exists dim_provincia_domicilio;

	create table dim_provincia_domicilio as 
	select row_number() over () as ids_provincia_domicilio, * from (
	select distinct trim( lower(provincia_domicilio)) as provincia_domicilio
	from sondaggio.progetto_andromeda pa 
	order by provincia_domicilio
	) t;
	
	-- tabella pulita con i case when
	drop table if exists dim_provincia_domicilio;
	
	create table dim_provincia_domicilio as 
	select row_number () over() , * from (select distinct 
	trim (INITCAP (
		case
        when provincia_domicilio = 'bo'
        	then 'bologna'
        when provincia_domicilio = 'rm'
        	then 'roma'
        when provincia_domicilio = 'mn'
        	then 'mantova'
        when provincia_domicilio = 'villamaina(av)'
        	then 'avellino'
        when provincia_domicilio = 'via del giardinetto 30 marlia'
        	then 'lucca'
        when provincia_domicilio = 'tunisi'
        	then 'estero'
        when provincia_domicilio = 'forlì cesena'
        	then 'forlì-cesena'
        else provincia_domicilio 
        end   )
                
	) as provincia_domicilio from (select trim(lower(provincia_domicilio)) as provincia_domicilio
	from sondaggio.progetto_andromeda pa)
	order by provincia_domicilio) t;
	
	select *  from dim_provincia_domicilio
	
	

	
select * from dim_provincia_domicilio

-- adesso procediamo con la "dim_grandezza_azienda"

drop table if exists dim_grandezza_azienda;

create table dim_grandezza_azienda as 
 select row_number() over () as ids_grandezza_azienda, * from (
   select distinct pa.grandezza_azienda 
from sondaggio.progetto_andromeda pa
) t
order by grandezza_azienda; -- ho inserito l'order by perchè c'è una variazione di numeri

-- creazione della "dim_durata_lavoro_in_azienda"




drop table if exists dim_durata_lavoro_in_azienda;

create table dim_durata_lavoro_in_azienda  as
select
	row_number() over(order by t.durata_lavoro_in_azienda) as 
	ids_durata_lavoro_in_azienda, t.* from (
	select distinct coalesce(nullif(trim(pa.durata_lavoro_in_azienda), ''),
	'Non indicato') as durata_lavoro_in_azienda
	from sondaggio.progetto_andromeda pa
	) t;

-- creazione dim_provincia_ultimo_lavoro

drop table if exists dim_provincia_ultimo_lavoro;

create table dim_provincia_ultimo_lavoro  as 
 select row_number() over () as ids_provincia_ultimo_lavoro, * from (
   select distinct trim(lower(provincia_ultimo_lavoro)) as provincia_ultimo_lavoro
from sondaggio.progetto_andromeda pa

) t 
order by provincia_ultimo_lavoro;   

-- 5 dicembre 2025


drop table if exists dim_provincia_ultimo_lavoro;
	
	create table dim_provincia_ultimo_lavoro as 
	select row_number () over() , * from (select distinct 
	trim (INITCAP (
		case
        when provincia_ultimo_lavoro = 'vr'
        	then 'verona'
        when provincia_ultimo_lavoro = 'ra'
        	then 'ravenna'
        when provincia_ultimo_lavoro = 'bo'
        	then 'bologna'
        when provincia_ultimo_lavoro = 'villamaina(av)'
        	then 'avellino'
        when provincia_ultimo_lavoro = 'marlia'
        	then 'lucca'
        when provincia_ultimo_lavoro = 'germania'
        	then 'estero'
        when provincia_ultimo_lavoro = 'non lavoro'
        	then 'altro'
        when provincia_ultimo_lavoro = 'rm'
        	then 'roma'
        else provincia_ultimo_lavoro 
        end   )
                
	) as provincia_ultimo_lavoro from (select trim(lower(provincia_ultimo_lavoro))
	as provincia_ultimo_lavoro
	from sondaggio.progetto_andromeda pa)
	order by provincia_ultimo_lavoro) t; --purtroppo questa non funziona


--qui sotto ci metto per comodità la dimensione con la trim e lower

create table dim_provincia_domicilio as 
	select row_number() over () as ids_provincia_domicilio, * from (
	select distinct trim( lower(provincia_domicilio)) as provincia_domicilio
	from sondaggio.progetto_andromeda pa 
	order by provincia_domicilio
	) t;



-- creazione dim_vittima_o_testimone_in_azienda

drop table if exists dim_vittima_o_testimone_di_discriminazione_in_azienda;

create table dim_vittima_o_testimone_di_discriminazione_in_azienda   as 
 select row_number() over () as ids_vittima_o_testimone_di_discriminazione_in_azienda, * from (
   select distinct pa.vittima_o_testimone_di_discriminazione_in_azienda
from sondaggio.progetto_andromeda pa

) t 
order by vittima_o_testimone_di_discriminazione_in_azienda;

-- creazione dim_tipo_discriminazione

drop table if exists dim_tipo_discriminazione;

create table dim_tipo_discriminazione as 
select row_number() over () as ids_tipo_discriminazione, * from (
select distinct pa.tipo_discriminazione
from sondaggio.progetto_andromeda pa

) t;

-- questa query di dim_tipo_discriminazione da i risultati con le virgole,quindi sono dati sporchi

drop table if exists dim_tipo_discriminazione;

create table dim_tipo_discriminazione as

select  row_number () over(
	 order by (valore_discriminazione = 'Nessuna discriminazione indicata')
	desc, valore_discriminazione) as ids_tipo_discriminazione,
	valore_discriminazione as tipo_discriminazione from
	(select distinct coalesce(nullif(trim(pa.tipo_discriminazione), ''),
	'Nessuna discriminazione indicata')
as valore_discriminazione from sondaggio.progetto_andromeda pa
) t; 


-- questa query serve a togliere le virgole dai valori
-- SELECT  unnest(string_to_array(pa.tipo_discriminazione , ',')) FROM sondaggio.progetto_andromeda pa ;

-- creazione dim_tipo_discriminazione funzionante

drop table if exists dim_tipo_discriminazione;

create table dim_tipo_discriminazione as
SELECT 
    row_number() OVER (
        ORDER BY 
            (valore_discriminazione = 'Nessuna discriminazione indicata') DESC, 
            valore_discriminazione
    ) as ids_tipo_discriminazione,
    valore_discriminazione as tipo_discriminazione
FROM 
    (
    -- LIVELLO 2: Pulisce i dati, gestisce i NULL e rimuove i duplicati
    select distinct 
        COALESCE(NULLIF(TRIM(t1.singolo_elemento), ''), 'Nessuna discriminazione indicata') 
        as valore_discriminazione
    FROM 
        (
        -- LIVELLO 1 (Il cuore): Spacchetta le stringhe separate dalla virgola
        SELECT 
            unnest(string_to_array(pa.tipo_discriminazione, ',')) as singolo_elemento 
        FROM 
            sondaggio.progetto_andromeda pa
        ) t1
    ) t2;







-- creazione dim_vittima_o_testimone_di_violenza

drop table if exists dim_vittima_o_testimone_di_violenza;

create table dim_vittima_o_testimone_di_violenza as 
select row_number() over () ids_vittima_o_testimone_di_violenza, * from (
select distinct pa.vittima_o_testimone_di_violenza
from sondaggio.progetto_andromeda pa

) t;

-- creazione dim_tipo_violenza


-- qui sotto la query che funziona con i dati puliti della dim_tipo_violenza

drop table if exists dim_tipo_violenza;

create table dim_tipo_violenza as
SELECT 
    row_number() OVER (
        ORDER BY 
            (valore_violenza = 'Nessuna violenza indicata') DESC, 
            valore_violenza
    ) as ids_tipo_violenza,
    valore_violenza as tipo_violenza
FROM 
    (
    -- LIVELLO 2: Pulisce gli spazi, gestisce i NULL/vuoti e rimuove i duplicati
    SELECT DISTINCT 
        COALESCE(NULLIF(TRIM(t1.singolo_elemento), ''), 'Nessuna violenza indicata') 
        as valore_violenza
    FROM 
        (
        -- LIVELLO 1: Spacchetta le stringhe separate da virgola
        SELECT 
            unnest(string_to_array(pa.tipo_violenza, ',')) as singolo_elemento 
        FROM 
            sondaggio.progetto_andromeda pa
        ) t1
    ) t2;

-- creazione dim_presenza_formazione_antidiscriminazione_in_azienda

drop table if exists dim_presenza_formazione_antidiscriminazione_in_azienda;

create table dim_presenza_formazione_antidiscriminazione_in_azienda as 
select row_number() over () ids_presenza_formazione_antidiscriminazione_in_azienda, * from (
select distinct pa.presenza_formazione_antidiscriminazione_in_azienda
from sondaggio.progetto_andromeda pa

) t; --questa è pulita

-- creazione dim_presenza_regolamenti_antidiscriminazione



-- qua sotto c'è il fittizio




drop table if exists dim_presenza_regolamenti_antidiscriminazione;

create table dim_presenza_regolamenti_antidiscriminazione as
	select
	row_number() over(order by t.presenza_regolamenti_antidiscriminazione) as 
	ids_presenza_regolamenti_antidiscriminazione, t.* from (
	select distinct coalesce(nullif(trim(pa.presenza_regolamenti_antidiscriminazione), ''),
	'Non indicato') as presenza_regolamenti_antidiscriminazione
	from sondaggio.progetto_andromeda pa
	) t;

select * from dim_presenza_regolamenti_antidiscriminazione dpra 

select * from dim_provincia_ultimo_lavoro dpul 

drop table if exists dim_provincia_domicilio;

-- qui ci sono le dimensioni che abbiamo cercato di automatizzare
	
	create table dim_provincia_domicilio as
	select row_number () over() , * from (
	select distinct p."Sigla" from sondaggio.progetto_andromeda a
	join province_italiane p on (p."Sigla"=a."provincia_domicilio"
	or p."Provincia"=a."provincia_domicilio"))
	
	
	drop table if exists dim_provincia_ultimo_lavoro;
	
	create table dim_provincia_ultimo_lavoro as
	select row_number () over() , * from (
	select distinct p."Sigla" from sondaggio.progetto_andromeda a
	join province_italiane p on (p."Sigla"=a."provincia_ultimo_lavoro"
	or p."Provincia"=a."provincia_ultimo_lavoro")) -- funziona ma non ha
	-- i valori giusti dell'estero o di altri paesi
	
	
	-- queste due dimensioni qua sotto funzionano ma solo manualmente e non sono automatizzate
	
	drop table if exists dim_provincia_domicilio;
	
	create table dim_provincia_domicilio as 
	select row_number () over() , * from (select distinct 
	trim (INITCAP (
		case
        when provincia_domicilio = 'bo'
        	then 'bologna'
        when provincia_domicilio = 'rm'
        	then 'roma'
        when provincia_domicilio = 'mn'
        	then 'mantova'
        when provincia_domicilio = 'villamaina(av)'
        	then 'avellino'
        when provincia_domicilio = 'via del giardinetto 30 marlia'
        	then 'lucca'
        when provincia_domicilio = 'tunisi'
        	then 'estero'
        when provincia_domicilio = 'forlì cesena'
        	then 'forlì-cesena'
        else provincia_domicilio 
        end   )
                
	) as provincia_domicilio from (select trim(lower(provincia_domicilio)) as provincia_domicilio
	from sondaggio.progetto_andromeda pa)
	order by provincia_domicilio) t;
	
	
	-- questa qua sotto è la dim_provincia_ultimo_lavoro
	
	drop table if exists dim_provincia_ultimo_lavoro;
	
	create table dim_provincia_ultimo_lavoro as 
	select row_number () over() , * from (select distinct 
	trim (INITCAP (
		case
        when provincia_ultimo_lavoro = 'vr'
        	then 'verona'
        when provincia_ultimo_lavoro = 'ra'
        	then 'ravenna'
        when provincia_ultimo_lavoro = 'bo'
        	then 'bologna'
        when provincia_ultimo_lavoro = 'villamaina(av)'
        	then 'avellino'
        when provincia_ultimo_lavoro = 'marlia'
        	then 'lucca'
        when provincia_ultimo_lavoro = 'germania'
        	then 'estero'
        when provincia_ultimo_lavoro = 'non lavoro'
        	then 'altro'
        when provincia_ultimo_lavoro = 'rm'
        	then 'roma'
        else provincia_ultimo_lavoro 
        end   )
                
	) as provincia_ultimo_lavoro from (select trim(lower(provincia_ultimo_lavoro))
	as provincia_ultimo_lavoro
	from sondaggio.progetto_andromeda pa)
	order by provincia_ultimo_lavoro) t;